<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Calepin - Partageable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        mark { background-color: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden font-sans text-slate-900">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col transform transition-transform duration-200 absolute md:relative z-30 h-full -translate-x-full md:translate-x-0">
        <div class="p-4 border-b border-slate-100 space-y-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-indigo-600 text-white p-1.5 rounded-md">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    </span>
                    Calepin Partagé
                </h1>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="createNewNote()" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-lg transition-colors font-medium shadow-sm text-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Nouvelle
                </button>
                <!-- Bouton IMPORT -->
                <button onclick="document.getElementById('importInput').click()" class="flex items-center justify-center gap-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 py-2 px-3 rounded-lg transition-colors font-medium shadow-sm text-sm" title="Importer une note reçue">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Importer
                </button>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="handleImport(this)">
            </div>

            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="Rechercher..." class="block w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
            </div>
        </div>
        <div id="notes-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>
        <div class="p-3 text-xs text-center text-slate-400 border-t border-slate-100 bg-slate-50">
            Stockage Local Sécurisé
        </div>
    </aside>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 z-20 hidden backdrop-blur-sm md:hidden"></div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full bg-slate-50 w-full relative">
        <header class="md:hidden h-14 border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0">
            <button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <span class="font-semibold text-slate-700">Mon Calepin</span>
            <div class="w-8"></div>
        </header>

        <div class="h-16 border-b border-slate-200 bg-white flex items-center justify-between px-4 md:px-8 shrink-0 shadow-sm z-10">
            <div id="status-msg" class="text-sm text-slate-500 flex items-center gap-2">Prêt</div>

            <div class="flex items-center gap-2 md:gap-3">
                <!-- Bouton PARTAGER (Export JSON) -->
                <button onclick="shareNoteFile()" class="flex items-center gap-2 bg-sky-50 text-sky-700 border border-sky-200 hover:bg-sky-100 px-3 py-2 rounded-lg transition-colors text-sm font-medium" title="Envoyer cette note à un ami (Fichier)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                    <span class="hidden lg:inline">Partager Note</span>
                </button>
                
                <div class="w-px h-6 bg-slate-200 mx-1"></div>

                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                <button onclick="document.getElementById('imageInput').click()" class="p-2 md:px-3 md:py-2 text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Ajouter une photo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </button>

                <!-- Bouton Export HTML (Visuel) -->
                <button onclick="exportHTML()" class="p-2 md:px-3 md:py-2 text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Visualiser en HTML (Lecture seule)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>

                <div class="w-px h-6 bg-slate-200 mx-1"></div>

                <button onclick="saveCurrentNote()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-colors font-medium text-sm">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    <span class="hidden md:inline">Sauvegarder</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full">
            <input type="text" id="note-title" placeholder="Titre de la note..." class="w-full text-3xl md:text-4xl font-bold text-slate-800 placeholder-slate-300 border-none outline-none bg-transparent mb-6">
            <textarea id="note-content" placeholder="Commencez à écrire ici..." class="w-full h-[40vh] md:h-[50vh] resize-none text-lg text-slate-600 placeholder-slate-300 border-none outline-none bg-transparent leading-relaxed"></textarea>
            <div id="image-grid-container" class="hidden mt-8 border-t border-slate-200 pt-6">
                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    Photos jointes (<span id="img-count">0</span>)
                </h3>
                <div id="image-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </main>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-opacity duration-300 opacity-0 pointer-events-none transform -translate-y-2">Message</div>

    <!-- EXPORT HTML VISUAL MODAL -->
    <div id="export-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Visualisation HTML</h2>
                <button onclick="closeExportModal()" class="text-slate-400 hover:text-slate-600"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <textarea id="export-area" readonly class="w-full flex-1 min-h-[200px] p-3 bg-slate-100 border border-slate-300 rounded-lg font-mono text-xs text-slate-600 resize-none mb-4" onclick="this.select()"></textarea>
            <button onclick="copyToClipboard()" class="w-full flex items-center justify-center gap-2 p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Copier le code</button>
        </div>
    </div>

    <script>
        let notes = [];
        let currentNoteId = null;
        let currentImages = [];
        let searchTerm = "";

        // --- PARTAGE & IMPORT (Le cœur de la demande) ---

        // 1. Partager (Exporter UNE note en JSON)
        function shareNoteFile() {
            // Sauvegarder d'abord l'état actuel pour être sûr
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value;
            
            // Créer l'objet note
            const noteToShare = {
                id: Date.now().toString(), // Nouvel ID pour éviter conflits basiques
                title: title || "Note Partagée",
                content: content,
                images: currentImages,
                updatedAt: Date.now(),
                type: 'calepin_share_v1' // Marqueur de sécurité
            };

            const dataStr = JSON.stringify(noteToShare, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const safeName = (title || "note").replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `${safeName}.json`; // Extension JSON pour import facile
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast("Fichier note généré ! Envoyez-le à votre ami.");
        }

        // 2. Importer (Lire un fichier JSON et l'ajouter sans écraser)
        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedNote = JSON.parse(e.target.result);
                    
                    // Vérification sommaire du format
                    if (!importedNote.title && !importedNote.content) {
                        throw new Error("Format invalide");
                    }

                    // Logique Anti-Écrasement : Créer un nouvel ID unique
                    importedNote.id = Date.now().toString() + Math.floor(Math.random() * 1000);
                    importedNote.title = "[Import] " + (importedNote.title || "Sans titre");
                    importedNote.updatedAt = Date.now();

                    // Ajouter à la liste existante (PUSH)
                    notes.unshift(importedNote);
                    saveToStorage();
                    
                    // Charger la note importée
                    loadNote(importedNote.id);
                    showToast("Note importée avec succès !", "success");

                } catch (err) {
                    console.error(err);
                    showToast("Erreur: Fichier note invalide", "error");
                }
                input.value = ""; // Reset
            };
            reader.readAsText(file);
        }


        // --- CORE FUNCTIONS (Standard) ---
        function normalizeText(text) { return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
        function getHighlightedSnippet(text, term) {
            if (!text) return "<em>(Vide)</em>";
            if (!term) return text.substring(0, 60) + (text.length > 60 ? "..." : "");
            const normText = normalizeText(text); const normTerm = normalizeText(term);
            const index = normText.indexOf(normTerm);
            if (index === -1) return text.substring(0, 60) + (text.length > 60 ? "..." : "");
            let start = Math.max(0, index - 30); let end = Math.min(text.length, index + term.length + 30);
            let snippet = text.substring(start, end);
            if (start > 0) snippet = "..." + snippet; if (end < text.length) snippet = snippet + "...";
            const regex = new RegExp(`(${term})`, 'gi');
            return snippet.replace(regex, '<mark>$1</mark>');
        }
        function highlightTitle(title, term) {
            if (!term || !title) return title || "Sans titre";
            const regex = new RegExp(`(${term})`, 'gi');
            return title.replace(regex, '<mark>$1</mark>');
        }
        function init() {
            const savedNotes = localStorage.getItem('mes-notes-locales');
            if (savedNotes) { notes = JSON.parse(savedNotes); renderNotesList(); }
            if (notes.length === 0) createNewNote(false); else loadNote(notes[0].id);
        }
        function handleSearch(value) { searchTerm = value.trim(); renderNotesList(); }
        function saveToStorage() { localStorage.setItem('mes-notes-locales', JSON.stringify(notes)); }
        function createNewNote(shouldRender = true) {
            currentNoteId = Date.now().toString(); currentImages = [];
            document.getElementById('note-title').value = ""; document.getElementById('note-content').value = "";
            if(searchTerm) { document.getElementById('search-input').value = ""; searchTerm = ""; renderNotesList(); }
            renderImages(); if(window.innerWidth < 768) toggleSidebar(false); showStatus("Nouvelle note brouillon");
        }
        function saveCurrentNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value;
            if (!title && !content && currentImages.length === 0) { showToast("Note vide !", "error"); return; }
            const noteData = { id: currentNoteId, title: title || "Note sans titre", content: content, images: currentImages, updatedAt: Date.now() };
            const existingIndex = notes.findIndex(n => n.id === currentNoteId);
            if (existingIndex >= 0) notes[existingIndex] = noteData; else notes.unshift(noteData);
            saveToStorage(); renderNotesList(); showToast("Note sauvegardée !"); showStatus("Sauvegardé à " + new Date().toLocaleTimeString());
        }
        function loadNote(id) {
            const note = notes.find(n => n.id === id); if (!note) return;
            currentNoteId = note.id;
            document.getElementById('note-title').value = note.title; document.getElementById('note-content').value = note.content || "";
            currentImages = note.images || []; renderImages(); renderNotesList();
            if(window.innerWidth < 768) toggleSidebar(false);
        }
        function deleteNote(e, id) {
            e.stopPropagation(); if(!confirm("Supprimer ?")) return;
            notes = notes.filter(n => n.id !== id); saveToStorage();
            if (currentNoteId === id) { if (notes.length > 0) loadNote(notes[0].id); else createNewNote(); } else renderNotesList();
            showToast("Note supprimée");
        }
        function renderNotesList() {
            const list = document.getElementById('notes-list'); list.innerHTML = "";
            let displayNotes = notes;
            if (searchTerm) {
                const normTerm = normalizeText(searchTerm);
                displayNotes = notes.filter(note => {
                    const t = normalizeText(note.title || ""); const c = normalizeText(note.content || "");
                    return t.includes(normTerm) || c.includes(normTerm);
                });
            }
            if (displayNotes.length === 0) { list.innerHTML = `<div class="text-center py-10 px-4 text-slate-400 text-sm italic">${searchTerm ? "Aucun résultat." : "Aucune note."}</div>`; return; }
            displayNotes.sort((a,b) => b.updatedAt - a.updatedAt).forEach(note => {
                const isActive = note.id === currentNoteId;
                const displayTitle = searchTerm ? highlightTitle(note.title, searchTerm) : (note.title || "Sans titre");
                const displayContent = searchTerm ? getHighlightedSnippet(note.content, searchTerm) : (note.content ? note.content.substring(0, 60) + (note.content.length>60?"...":"") : (note.images.length ? '<em>[Photos]</em>' : '<em>Vide</em>'));
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer border transition-all duration-200 mb-2 relative group ${isActive ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'bg-white border-transparent hover:bg-slate-50 hover:border-slate-200'}`;
                div.onclick = () => loadNote(note.id);
                div.innerHTML = `<div class="flex justify-between items-start mb-1"><h3 class="font-semibold truncate text-sm ${isActive ? 'text-indigo-900' : 'text-slate-700'} w-4/5">${displayTitle}</h3><button onclick="deleteNote(event, '${note.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><p class="text-xs text-slate-500 line-clamp-2 h-8 overflow-hidden text-ellipsis leading-relaxed">${displayContent}</p>`;
                list.appendChild(div);
            });
        }
        function renderImages() {
            const grid = document.getElementById('image-grid'); const container = document.getElementById('image-grid-container'); const countSpan = document.getElementById('img-count');
            if (currentImages.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden'); countSpan.innerText = currentImages.length; grid.innerHTML = "";
            currentImages.forEach((imgSrc, idx) => {
                const div = document.createElement('div'); div.className = "relative group rounded-xl overflow-hidden shadow-sm border border-slate-200 bg-white aspect-square";
                div.innerHTML = `<img src="${imgSrc}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100"><button onclick="removeImage(${idx})" class="bg-white text-red-600 p-2 rounded-full hover:bg-red-50 shadow-lg transform scale-90 group-hover:scale-100 transition-all"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`;
                grid.appendChild(div);
            });
        }
        function handleImageUpload(input) {
            const file = input.files[0]; if (!file) return; showStatus("Compression...");
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const scale = 800 / Math.max(img.width, 800);
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentImages.push(canvas.toDataURL('image/jpeg', 0.7)); renderImages(); showStatus("Ajoutée"); showToast("Image ajoutée"); input.value = "";
                };
            };
        }
        function removeImage(idx) { currentImages.splice(idx, 1); renderImages(); }
        function exportHTML() {
            const title = document.getElementById('note-title').value || "Note"; const content = document.getElementById('note-content').value; const date = new Date().toLocaleDateString();
            let html = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>${title}</title><style>body{font-family:system-ui,sans-serif;max-width:800px;margin:20px auto;padding:20px;line-height:1.6;color:#333}h1{border-bottom:2px solid #eee;padding-bottom:10px}.img-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;margin-top:30px}img{width:100%;border-radius:4px;border:1px solid #ddd}</style></head><body><h1>${title}</h1><p style="color:#888">${date}</p><div style="white-space:pre-wrap">${content}</div>`;
            if (currentImages.length > 0) { html += `<div class="img-grid">`; currentImages.forEach(img => html += `<img src="${img}">`); html += `</div>`; } html += `</body></html>`;
            document.getElementById('export-area').value = html; document.getElementById('export-modal').classList.remove('hidden'); document.getElementById('export-modal').classList.add('flex');
        }
        function closeExportModal() { document.getElementById('export-modal').classList.add('hidden'); document.getElementById('export-modal').classList.remove('flex'); }
        function copyToClipboard() { document.getElementById('export-area').select(); document.execCommand('copy'); showToast("Code copié !"); }
        function toggleSidebar(force) { const sb = document.getElementById('sidebar'); const ol = document.getElementById('overlay'); if (force!==undefined?force:sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ol.classList.remove('hidden'); } else { sb.classList.add('-translate-x-full'); ol.classList.add('hidden'); } }
        function showToast(msg, type='success') { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300 transform ${type==='error'?'bg-red-500':'bg-emerald-600'} translate-y-0 opacity-100`; setTimeout(() => { t.classList.remove('translate-y-0', 'opacity-100'); t.classList.add('-translate-y-2', 'opacity-0'); }, 3000); }
        function showStatus(msg) { document.getElementById('status-msg').innerText = msg; }
        init();
    </script>
</body>
</html>


