<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Calepin - Ultimate</title>
    <!-- Tailwind CSS pour le design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Scrollbar √©l√©gante */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        /* Surlignage pour la recherche */
        mark { background-color: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; }
        
        /* Animation pulsante pour le bouton IA */
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); }
            100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); }
        }
        .btn-ai:hover { animation: pulse-purple 2s infinite; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden font-sans text-slate-900">

    <!-- VOLET LAT√âRAL (SIDEBAR) -->
    <aside id="sidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col transform transition-transform duration-200 absolute md:relative z-30 h-full -translate-x-full md:translate-x-0">
        
        <!-- En-t√™te Sidebar -->
        <div class="p-4 border-b border-slate-100 space-y-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-indigo-600 text-white p-1.5 rounded-md">
                        <!-- Icone Livre -->
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    </span>
                    Mon Calepin
                </h1>
                <!-- Bouton fermer (mobile) -->
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            
            <button onclick="createNewNote()" class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 rounded-lg transition-colors font-medium shadow-sm">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Nouvelle Note
            </button>

            <!-- Barre de Recherche -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="Rechercher..." class="block w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
            </div>
        </div>

        <!-- Liste des notes -->
        <div id="notes-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
            <!-- Inject√© par JS -->
        </div>

        <!-- Pied de page Sidebar : GESTION SAUVEGARDES -->
        <div class="p-3 bg-slate-50 border-t border-slate-200">
            <h3 class="text-[10px] uppercase font-bold text-slate-400 mb-2 tracking-wider">Sauvegardes & Migration</h3>
            <div class="grid grid-cols-2 gap-2">
                
                <!-- Bouton Backup Global -->
                <button onclick="backupAllNotes()" class="flex flex-col items-center justify-center p-2 bg-white border border-slate-300 rounded hover:bg-slate-100 hover:border-slate-400 transition-all group" title="Tout sauvegarder dans un fichier">
                    <svg class="text-slate-500 group-hover:text-indigo-600 mb-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    <span class="text-[10px] font-medium text-slate-600">Sauvegarde</span>
                </button>

                <!-- Bouton Restauration/Import -->
                <button onclick="document.getElementById('importInput').click()" class="flex flex-col items-center justify-center p-2 bg-white border border-slate-300 rounded hover:bg-slate-100 hover:border-slate-400 transition-all group" title="Importer un fichier (Note ou Backup)">
                    <svg class="text-slate-500 group-hover:text-emerald-600 mb-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span class="text-[10px] font-medium text-slate-600">Restaurer</span>
                </button>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="handleUniversalImport(this)">
            </div>
            <div class="text-[10px] text-center text-slate-400 mt-2">v5.0 Ultimate ‚Ä¢ Donn√©es Locales</div>
        </div>
    </aside>

    <!-- Overlay Mobile -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 z-20 hidden backdrop-blur-sm md:hidden"></div>

    <!-- ZONE PRINCIPALE -->
    <main class="flex-1 flex flex-col h-full bg-slate-50 w-full relative">
        <!-- Header Mobile -->
        <header class="md:hidden h-14 border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0">
            <button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <span class="font-semibold text-slate-700">Mon Calepin</span>
            <div class="w-8"></div>
        </header>

        <!-- BARRE D'OUTILS -->
        <div class="h-16 border-b border-slate-200 bg-white flex items-center justify-between px-4 md:px-8 shrink-0 shadow-sm z-10">
            <div id="status-msg" class="text-sm text-slate-500 flex items-center gap-2">Pr√™t</div>

            <div class="flex items-center gap-2 md:gap-3">
                
                <!-- Bouton IA -->
                <button onclick="analyzeCurrentNote()" class="btn-ai bg-violet-100 text-violet-700 hover:bg-violet-200 border border-violet-200 px-3 py-2 rounded-lg flex items-center gap-2 transition-colors font-medium text-sm mr-2" title="Analyser avec l'IA">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 2a10 10 0 0 1 10 10"></path><path d="M2 12h10"></path></svg>
                    <span class="hidden lg:inline">IA</span>
                </button>

                <!-- Bouton Partager (Export Note seule) -->
                <button onclick="shareNoteFile()" class="p-2 md:px-3 md:py-2 text-slate-600 hover:text-sky-600 hover:bg-sky-50 rounded-lg transition-colors" title="Partager cette note (Fichier)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
                
                <div class="w-px h-6 bg-slate-200 mx-1"></div>

                <!-- Upload Image -->
                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                <button onclick="document.getElementById('imageInput').click()" class="p-2 md:px-3 md:py-2 text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Ajouter une photo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </button>

                <!-- Export HTML Visualisation -->
                <button onclick="exportHTML()" class="p-2 md:px-3 md:py-2 text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Code HTML de la note">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>

                <div class="w-px h-6 bg-slate-200 mx-1"></div>

                <!-- Bouton Sauvegarder Note -->
                <button onclick="saveCurrentNote()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-colors font-medium text-sm">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    <span class="hidden md:inline">Sauvegarder</span>
                </button>
            </div>
        </div>

        <!-- ZONE D'√âDITION -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full">
            <input type="text" id="note-title" placeholder="Titre de la note..." class="w-full text-3xl md:text-4xl font-bold text-slate-800 placeholder-slate-300 border-none outline-none bg-transparent mb-6">
            <textarea id="note-content" placeholder="Commencez √† √©crire ici..." class="w-full h-[40vh] md:h-[50vh] resize-none text-lg text-slate-600 placeholder-slate-300 border-none outline-none bg-transparent leading-relaxed"></textarea>
            
            <!-- Grille Images -->
            <div id="image-grid-container" class="hidden mt-8 border-t border-slate-200 pt-6">
                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    Photos jointes (<span id="img-count">0</span>)
                </h3>
                <div id="image-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </main>

    <!-- NOTIFICATION FLOTTANTE (TOAST) -->
    <div id="toast" class="fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-opacity duration-300 opacity-0 pointer-events-none transform -translate-y-2">Message</div>

    <!-- MODALE EXPORT HTML -->
    <div id="export-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800">Visualisation HTML</h2><button onclick="closeExportModal()" class="text-slate-400 hover:text-slate-600"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
            <textarea id="export-area" readonly class="w-full flex-1 min-h-[200px] p-3 bg-slate-100 border border-slate-300 rounded-lg font-mono text-xs text-slate-600 resize-none mb-4" onclick="this.select()"></textarea>
            <button onclick="copyToClipboard()" class="w-full flex items-center justify-center gap-2 p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Copier le code</button>
        </div>
    </div>

    <!-- MODALE ANALYSE IA -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 flex flex-col max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100"><h2 class="text-xl font-bold text-slate-800">‚ú® Analyse Intelligente</h2><button onclick="closeAiModal()" class="text-slate-400 hover:text-slate-600"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
            <div class="overflow-y-auto space-y-6 pr-2">
                <div><h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">R√©sum√© Automatique</h3><div id="ai-summary" class="p-4 bg-violet-50 rounded-lg text-slate-700 leading-relaxed border border-violet-100 text-sm">Chargement...</div></div>
                <div><h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Mots Cl√©s</h3><div id="ai-keywords" class="flex flex-wrap gap-2"></div></div>
                <div class="grid grid-cols-2 gap-4"><div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><h4 class="text-xs text-slate-400 mb-1">Sentiment</h4><div id="ai-sentiment" class="text-lg font-medium text-slate-700"></div></div><div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><h4 class="text-xs text-slate-400 mb-1">Temps de lecture</h4><div id="ai-readtime" class="text-lg font-medium text-slate-700"></div></div></div>
            </div>
            <div class="mt-6 pt-4 border-t border-slate-100 text-xs text-center text-slate-400">Analyse 100% locale. Aucune donn√©e n'est envoy√©e.</div>
        </div>
    </div>

    <!-- LOGIQUE JAVASCRIPT -->
    <script>
        // --- 1. VARIABLES D'√âTAT ---
        let notes = [];
        let currentNoteId = null;
        let currentImages = [];
        let searchTerm = "";
        const storageKey = 'mes-notes-locales'; // Cl√© unique pour la r√©cup√©ration auto
        
        // Mots vides pour l'IA (Stopwords)
        const stopWords = new Set(["le","la","les","de","des","du","un","une","et","√†","en","il","elle","est","a","que","qui","pour","sur","dans","ce","cette","mon","ton","son","avec","mais","ou","donc","pas","plus","moins","tr√®s","bien"]);

        // --- 2. FONCTIONS DE SAUVEGARDE ET MIGRATION ---

        // Cr√©er un fichier de sauvegarde complet (Backup)
        function backupAllNotes() {
            if (notes.length === 0) { showToast("Rien √† sauvegarder", "error"); return; }
            const backupData = { type: 'calepin_full_backup', timestamp: Date.now(), count: notes.length, data: notes };
            downloadJSON(backupData, `backup_calepin_${new Date().toISOString().slice(0,10)}.json`);
            showToast(`Sauvegarde de ${notes.length} notes t√©l√©charg√©e !`);
        }

        // Cr√©er un fichier pour une seule note (Partage)
        function shareNoteFile() {
            const t = document.getElementById('note-title').value.trim();
            const n = { id: Date.now().toString(), title: t||"Note Partag√©e", content: document.getElementById('note-content').value, images: currentImages, updatedAt: Date.now() };
            downloadJSON(n, `${(t||"note").replace(/[^a-z0-9]/gi,'_')}.json`);
            showToast("Note pr√™te √† √™tre envoy√©e !");
        }

        // Utilitaire t√©l√©chargement
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        // Import Universel (G√®re Backup Complet OU Note Seule)
        function handleUniversalImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    let countAdded = 0;

                    // CAS A : Backup Complet
                    if (json.type === 'calepin_full_backup' && Array.isArray(json.data)) {
                        if(!confirm(`Fusionner ${json.data.length} notes ? (Les existantes restent)`)) return;
                        json.data.forEach(n => {
                            if (!notes.some(existing => existing.id === n.id)) { notes.unshift(n); countAdded++; }
                        });
                    } 
                    // CAS B : Note Unique
                    else if (json.title || json.content) {
                        json.id = Date.now().toString() + Math.floor(Math.random()*1000); // Nouvel ID
                        json.title = "[Import] " + (json.title || "Note");
                        notes.unshift(json); countAdded++; loadNote(json.id);
                    }
                    
                    if(countAdded > 0) { saveToStorage(); renderNotesList(); showToast(`${countAdded} notes ajout√©es !`); }
                    else { showToast("Aucune nouvelle note (doublons ?)", "error"); }
                } catch (err) { console.error(err); showToast("Fichier invalide", "error"); }
                input.value = "";
            };
            reader.readAsText(file);
        }

        // --- 3. RECHERCHE & SURLIGNAGE ---
        function normalizeText(t) { return t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
        function getHighlightedSnippet(text, term) {
            if (!text) return "<em>(Vide)</em>"; if (!term) return text.substring(0, 60)+"...";
            const idx = normalizeText(text).indexOf(normalizeText(term));
            if (idx === -1) return text.substring(0, 60)+"...";
            const start = Math.max(0, idx - 30); const end = Math.min(text.length, idx + term.length + 30);
            return text.substring(start, end).replace(new RegExp(`(${term})`,'gi'), '<mark>$1</mark>') + "...";
        }
        function highlightTitle(t, term) { return (!term || !t) ? (t||"Sans titre") : t.replace(new RegExp(`(${term})`,'gi'), '<mark>$1</mark>'); }

        // --- 4. INTELLIGENCE ARTIFICIELLE LOCALE ---
        function runLocalAI(text) {
            if(!text || text.length<10) return null;
            const words = text.toLowerCase().match(/\b[\w√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø√±√¶≈ì]+\b/g)||[];
            const meaning = words.filter(w=>!stopWords.has(w)&&w.length>2);
            const freq={}; meaning.forEach(w=>freq[w]=(freq[w]||0)+1);
            const kw = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5).map(p=>p[0]);
            const sentences = text.match(/[^\.!\?]+[\.!\?]+/g)||[text];
            // R√©sum√© simple : prendre les 2 premi√®res phrases ou celles avec mots cl√©s
            const summary = sentences.slice(0,2).join(" ");
            let score=0; meaning.forEach(w=>{ if(["bon","bien","super","g√©nial","succ√®s"].includes(w)) score++; if(["mal","nul","triste","√©chec","probl√®me"].includes(w)) score--; });
            return { summary: summary||text.substring(0,100)+"...", keywords: kw, sentiment: score>0?"Positif üòä":(score<0?"N√©gatif üòü":"Neutre üòê"), readTime: Math.ceil(words.length/200)+" min" };
        }
        function analyzeCurrentNote() {
            const txt = (document.getElementById('note-title').value+". "+document.getElementById('note-content').value).trim();
            if(txt.length<20) { showToast("Note trop courte pour l'IA","error"); return; }
            const res = runLocalAI(txt);
            document.getElementById('ai-summary').innerText = res.summary;
            document.getElementById('ai-keywords').innerHTML = res.keywords.map(k=>`<span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded-full capitalize">${k}</span>`).join("");
            document.getElementById('ai-sentiment').innerText = res.sentiment; document.getElementById('ai-readtime').innerText = res.readTime;
            document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-modal').classList.add('flex');
        }
        function closeAiModal() { document.getElementById('ai-modal').classList.add('hidden'); document.getElementById('ai-modal').classList.remove('flex'); }

        // --- 5. FONCTIONS C≈íUR (CRUD) ---
        function init() {
            const saved = localStorage.getItem(storageKey);
            if (saved) { notes = JSON.parse(saved); renderNotesList(); }
            if (notes.length===0) createNewNote(false); else loadNote(notes[0].id);
        }
        function handleSearch(v) { searchTerm = v.trim(); renderNotesList(); }
        function saveToStorage() { localStorage.setItem(storageKey, JSON.stringify(notes)); }
        
        function createNewNote(shouldRender = true) {
            currentNoteId = Date.now().toString(); currentImages = [];
            document.getElementById('note-title').value = ""; document.getElementById('note-content').value = "";
            renderImages(); if(window.innerWidth<768) toggleSidebar(false); showStatus("Nouveau brouillon");
        }
        function saveCurrentNote() {
            const t = document.getElementById('note-title').value.trim(); const c = document.getElementById('note-content').value;
            if(!t && !c && !currentImages.length) { showToast("Note vide !","error"); return; }
            const n = { id: currentNoteId, title: t||"Note sans titre", content: c, images: currentImages, updatedAt: Date.now() };
            const idx = notes.findIndex(x=>x.id===currentNoteId);
            if(idx>=0) notes[idx]=n; else notes.unshift(n);
            saveToStorage(); renderNotesList(); showToast("Sauvegard√©"); showStatus("Sauvegard√© √† "+new Date().toLocaleTimeString());
        }
        function loadNote(id) {
            const n = notes.find(x=>x.id===id); if(!n) return;
            currentNoteId = n.id; document.getElementById('note-title').value=n.title; document.getElementById('note-content').value=n.content||"";
            currentImages = n.images||[]; renderImages(); renderNotesList(); if(window.innerWidth<768) toggleSidebar(false);
        }
        function deleteNote(e, id) {
            e.stopPropagation(); if(!confirm("Vraiment supprimer ?")) return;
            notes=notes.filter(x=>x.id!==id); saveToStorage();
            if(currentNoteId===id) { if(notes.length) loadNote(notes[0].id); else createNewNote(); } else renderNotesList();
            showToast("Note supprim√©e");
        }

        // --- 6. RENDU UI & IMAGES ---
        function renderNotesList() {
            const lst = document.getElementById('notes-list'); lst.innerHTML = "";
            let dNotes = notes;
            if(searchTerm) { const s = normalizeText(searchTerm); dNotes = notes.filter(n=>normalizeText(n.title||"").includes(s)||normalizeText(n.content||"").includes(s)); }
            if(!dNotes.length) { lst.innerHTML=`<div class="text-center py-10 text-slate-400 text-sm italic">Aucune note trouv√©e</div>`; return; }
            dNotes.sort((a,b)=>b.updatedAt-a.updatedAt).forEach(n => {
                const act = n.id===currentNoteId;
                const tit = searchTerm ? highlightTitle(n.title, searchTerm) : (n.title||"Sans titre");
                const con = searchTerm ? getHighlightedSnippet(n.content, searchTerm) : (n.content?n.content.substring(0,50)+"...":(n.images.length?"[Photos]":"Vide"));
                const div = document.createElement('div');
                div.className=`p-3 rounded-lg cursor-pointer border mb-2 group ${act?'bg-indigo-50 border-indigo-200':'bg-white hover:bg-slate-50 border-transparent'}`;
                div.onclick=()=>loadNote(n.id);
                div.innerHTML=`<div class="flex justify-between mb-1"><h3 class="font-semibold text-sm w-4/5 truncate ${act?'text-indigo-900':'text-slate-700'}">${tit}</h3><button onclick="deleteNote(event,'${n.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 px-1">‚úï</button></div><p class="text-xs text-slate-500 line-clamp-2">${con}</p>`;
                lst.appendChild(div);
            });
        }
        function renderImages() {
            const g = document.getElementById('image-grid'); const c = document.getElementById('image-grid-container');
            if(!currentImages.length) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden'); document.getElementById('img-count').innerText=currentImages.length; g.innerHTML="";
            currentImages.forEach((src,i)=>{
                const d=document.createElement('div'); d.className="relative group rounded-xl overflow-hidden shadow-sm aspect-square bg-slate-100";
                d.innerHTML=`<img src="${src}" class="w-full h-full object-cover"><button onclick="currentImages.splice(${i},1);renderImages()" class="absolute inset-0 bg-black/40 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">Supprimer</button>`;
                g.appendChild(d);
            });
        }
        function handleImageUpload(inp) {
            if(!inp.files[0]) return; showStatus("Compression...");
            const r=new FileReader(); r.readAsDataURL(inp.files[0]);
            r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{
                const c=document.createElement('canvas'); const s=800/Math.max(i.width,800); c.width=i.width*s; c.height=i.height*s;
                c.getContext('2d').drawImage(i,0,0,c.width,c.height); currentImages.push(c.toDataURL('image/jpeg',0.7)); renderImages(); showStatus("Image ajout√©e"); inp.value="";
            }};
        }

        // --- 7. EXPORT HTML & UTILS ---
        function exportHTML() {
            const t=document.getElementById('note-title').value||"Note"; const c=document.getElementById('note-content').value;
            let h=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${t}</title><style>body{font-family:sans-serif;max-width:800px;margin:20px auto;padding:20px}img{max-width:100%;border-radius:8px;margin-top:10px}</style></head><body><h1>${t}</h1><div>${c}</div>`;
            if(currentImages.length) h+=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;margin-top:20px">`+currentImages.map(i=>`<img src="${i}">`).join('')+`</div>`;
            h+=`</body></html>`;
            document.getElementById('export-area').value=h; document.getElementById('export-modal').classList.remove('hidden'); document.getElementById('export-modal').classList.add('flex');
        }
        function closeExportModal() { document.getElementById('export-modal').classList.add('hidden'); document.getElementById('export-modal').classList.remove('flex'); }
        function copyToClipboard() { document.getElementById('export-area').select(); document.execCommand('copy'); showToast("Copi√©!"); }
        function toggleSidebar(f) { const s=document.getElementById('sidebar'); const o=document.getElementById('overlay'); if(f!==undefined?f:s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } }
        function showToast(m,t='s') { const el=document.getElementById('toast'); el.innerText=m; el.className=`fixed top-4 right-4 z-50 px-4 py-2 rounded shadow text-white text-sm transition ${t==='error'?'bg-red-500':'bg-emerald-600'}`; setTimeout(()=>el.classList.add('opacity-0','-translate-y-2'),3000); el.classList.remove('opacity-0','-translate-y-2'); }
        function showStatus(m) { document.getElementById('status-msg').innerText=m; }
        
        // D√©marrage
        init();
    </script>
</body>
</html>


