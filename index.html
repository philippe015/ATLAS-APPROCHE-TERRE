<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Calepin - Platinum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
        
        /* Highlighting */
        mark { background-color: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; }
        
        /* Animations */
        @keyframes pulse-purple { 0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); } 100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); } }
        .btn-ai:hover { animation: pulse-purple 2s infinite; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .recording { animation: pulse-red 1.5s infinite; background-color: #fee2e2; border-color: #ef4444; color: #ef4444; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 h-screen flex overflow-hidden font-sans text-slate-900 dark:text-slate-100 transition-colors duration-300">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-80 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col transform transition-transform duration-200 absolute md:relative z-30 h-full -translate-x-full md:translate-x-0">
        
        <div class="p-4 border-b border-slate-100 dark:border-slate-700 space-y-4">
            <!-- HEADER -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <span class="bg-indigo-600 text-white p-1.5 rounded-md">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        </span>
                        Calepin
                    </h1>
                    
                    <div class="flex gap-2">
                        <!-- Dark Mode -->
                        <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" title="Mode Sombre/Clair">
                            <svg class="dark:hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                            <svg class="hidden dark:block" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        </button>
                        <!-- Close Mobile -->
                        <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>

                <!-- NOM UTILISATEUR (BOUTON CORRIGÃ‰) -->
                <button onclick="openProfileModal()" class="w-full text-left group flex items-center gap-2 px-3 py-2 bg-slate-50 dark:bg-slate-700/50 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all border border-slate-100 dark:border-slate-700 hover:border-indigo-200" title="Modifier mon profil">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 flex items-center justify-center font-bold text-xs">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider leading-none">Carnet de</span>
                        <span id="username-display" class="font-bold text-slate-700 dark:text-slate-200 text-sm truncate max-w-[140px]">...</span>
                    </div>
                    <svg class="ml-auto w-4 h-4 text-slate-300 group-hover:text-indigo-500 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
            </div>
            
            <button onclick="createNewNote()" class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 rounded-lg transition-colors font-medium shadow-sm">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Nouvelle Note
            </button>

            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="Rechercher..." class="block w-full pl-9 pr-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg text-sm placeholder-slate-400 dark:text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
            </div>
        </div>

        <div id="notes-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>

        <div class="p-3 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
            <h3 class="text-[10px] uppercase font-bold text-slate-400 mb-2 tracking-wider">DonnÃ©es</h3>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="backupAllNotes()" class="flex flex-col items-center justify-center p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-all group">
                    <svg class="text-slate-500 dark:text-slate-400 group-hover:text-indigo-600 mb-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    <span class="text-[10px] font-medium text-slate-600 dark:text-slate-300">Sauvegarde</span>
                </button>
                <button onclick="document.getElementById('importInput').click()" class="flex flex-col items-center justify-center p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-all group">
                    <svg class="text-slate-500 dark:text-slate-400 group-hover:text-emerald-600 mb-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span class="text-[10px] font-medium text-slate-600 dark:text-slate-300">Restaurer</span>
                </button>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="handleUniversalImport(this)">
            </div>
            <div class="text-[10px] text-center text-slate-400 mt-2">v8.0 Platinum Corrected</div>
        </div>
    </aside>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 z-20 hidden backdrop-blur-sm md:hidden"></div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full bg-slate-50 dark:bg-slate-900 w-full relative transition-colors duration-300">
        <header class="md:hidden h-14 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex items-center justify-between px-4 shrink-0">
            <button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600 dark:text-slate-300">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <span class="font-semibold text-slate-700 dark:text-slate-200">Mon Calepin</span>
            <button onclick="toggleDarkMode()" class="p-2 text-slate-600 dark:text-slate-300">
                 <svg class="dark:hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                 <svg class="hidden dark:block" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <!-- TOOLBAR -->
        <div class="h-16 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex items-center justify-between px-4 md:px-8 shrink-0 shadow-sm z-10 transition-colors duration-300">
            <div id="status-msg" class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2">PrÃªt</div>

            <div class="flex items-center gap-2 md:gap-3">
                <div class="flex gap-1 mr-2 hidden md:flex">
                    <button onclick="setNoteColor('transparent')" class="w-4 h-4 rounded-full border border-slate-300 bg-white hover:scale-110 transition-transform" title="DÃ©faut"></button>
                    <button onclick="setNoteColor('red')" class="w-4 h-4 rounded-full bg-red-400 hover:scale-110 transition-transform" title="Urgent"></button>
                    <button onclick="setNoteColor('green')" class="w-4 h-4 rounded-full bg-emerald-400 hover:scale-110 transition-transform" title="Personnel"></button>
                    <button onclick="setNoteColor('blue')" class="w-4 h-4 rounded-full bg-sky-400 hover:scale-110 transition-transform" title="Travail"></button>
                    <button onclick="setNoteColor('yellow')" class="w-4 h-4 rounded-full bg-amber-400 hover:scale-110 transition-transform" title="IdÃ©e"></button>
                </div>
                <button id="mic-btn" onclick="toggleDictation()" class="p-2 md:px-3 md:py-2 text-slate-600 dark:text-slate-300 hover:text-red-600 hover:bg-red-50 dark:hover:bg-slate-700 rounded-lg transition-colors border border-transparent" title="DictÃ©e vocale">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </button>
                <button onclick="analyzeCurrentNote()" class="btn-ai bg-violet-100 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300 hover:bg-violet-200 dark:hover:bg-violet-900/50 border border-violet-200 dark:border-violet-800 px-3 py-2 rounded-lg flex items-center gap-2 transition-colors font-medium text-sm" title="IA">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 2a10 10 0 0 1 10 10"></path><path d="M2 12h10"></path></svg>
                    <span class="hidden lg:inline">IA</span>
                </button>
                <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                <button onclick="document.getElementById('imageInput').click()" class="p-2 md:px-3 md:py-2 text-slate-600 dark:text-slate-300 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </button>
                <button onclick="shareNoteFile()" class="p-2 md:px-3 md:py-2 text-slate-600 dark:text-slate-300 hover:text-sky-600 hover:bg-sky-50 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
                <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                <button onclick="saveCurrentNote()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-colors font-medium text-sm">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    <span class="hidden md:inline">Sauver</span>
                </button>
            </div>
        </div>

        <!-- ZONE D'Ã‰DITION -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full transition-colors duration-300">
            <input type="text" id="note-title" placeholder="Titre de la note..." class="w-full text-3xl md:text-4xl font-bold text-slate-800 dark:text-white placeholder-slate-300 dark:placeholder-slate-600 border-none outline-none bg-transparent mb-6 transition-colors">
            <textarea id="note-content" placeholder="Commencez Ã  Ã©crire ici..." class="w-full h-[40vh] md:h-[50vh] resize-none text-lg text-slate-600 dark:text-slate-300 placeholder-slate-300 dark:placeholder-slate-600 border-none outline-none bg-transparent leading-relaxed transition-colors"></textarea>
            <div id="image-grid-container" class="hidden mt-8 border-t border-slate-200 dark:border-slate-700 pt-6">
                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    Photos jointes (<span id="img-count">0</span>)
                </h3>
                <div id="image-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </main>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-opacity duration-300 opacity-0 pointer-events-none transform -translate-y-2">Message</div>

    <!-- NOUVEAU: MODALE PROFIL (Pour remplacer le prompt qui peut bloquer) -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-sm w-full p-6 flex flex-col text-slate-800 dark:text-slate-200">
            <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold">Modifier votre nom</h2><button onclick="closeProfileModal()" class="text-slate-400 hover:text-slate-600">âœ•</button></div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Ce nom sera utilisÃ© pour signer vos notes partagÃ©es.</p>
            <input type="text" id="username-input" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Votre nom...">
            <button onclick="saveUsername()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors">Enregistrer</button>
        </div>
    </div>

    <!-- MODALE ANALYSE IA -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-2xl w-full p-6 flex flex-col max-h-[90vh] overflow-hidden text-slate-800 dark:text-slate-200">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100 dark:border-slate-700"><h2 class="text-xl font-bold flex items-center gap-2">âœ¨ Analyse Intelligente</h2><button onclick="closeAiModal()" class="text-slate-400 hover:text-slate-600">âœ•</button></div>
            <div class="overflow-y-auto space-y-6 pr-2">
                <div><h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">RÃ©sumÃ©</h3><div id="ai-summary" class="p-4 bg-violet-50 dark:bg-slate-700 rounded-lg text-slate-700 dark:text-slate-300 leading-relaxed border border-violet-100 dark:border-slate-600 text-sm">...</div></div>
                <div><h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Mots ClÃ©s</h3><div id="ai-keywords" class="flex flex-wrap gap-2"></div></div>
                <div class="grid grid-cols-2 gap-4"><div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-100 dark:border-slate-600"><h4 class="text-xs text-slate-400 mb-1">Sentiment</h4><div id="ai-sentiment" class="text-lg font-medium"></div></div><div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-100 dark:border-slate-600"><h4 class="text-xs text-slate-400 mb-1">Temps de lecture</h4><div id="ai-readtime" class="text-lg font-medium"></div></div></div>
            </div>
            <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-700 text-xs text-center text-slate-400">100% Local</div>
        </div>
    </div>

    <!-- MODALE EXPORT -->
    <div id="export-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800">HTML</h2><button onclick="closeExportModal()" class="text-slate-400 hover:text-slate-600">âœ•</button></div>
            <textarea id="export-area" readonly class="w-full flex-1 min-h-[200px] p-3 bg-slate-100 border border-slate-300 rounded-lg font-mono text-xs text-slate-600 resize-none mb-4" onclick="this.select()"></textarea>
            <button onclick="copyToClipboard()" class="w-full flex items-center justify-center gap-2 p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Copier</button>
        </div>
    </div>

    <script>
        // --- 1. ETAT ---
        let notes = []; let currentNoteId = null; let currentImages = []; let currentColor = 'transparent'; let searchTerm = ""; let username = "Moi";
        const storageKey = 'mes-notes-locales'; const userKey = 'mon-calepin-username';
        const stopWords = new Set(["le","la","les","de","des","du","un","une","et","Ã ","en","il","elle","est","a","que","qui","pour","sur","dans","ce","cette","mon","ton","son","avec","mais","ou","donc","pas"]);
        
        // --- 2. GESTION UTILISATEUR (MODALE) ---
        function loadUsername() {
            try { const s = localStorage.getItem(userKey); if(s) username = s; } catch(e) { console.warn("Storage access error"); }
            updateUsernameUI();
        }
        function openProfileModal() {
            document.getElementById('username-input').value = username;
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('flex');
            setTimeout(() => document.getElementById('username-input').focus(), 100);
        }
        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('profile-modal').classList.remove('flex');
        }
        function saveUsername() {
            const val = document.getElementById('username-input').value.trim();
            if(val) {
                username = val;
                try { localStorage.setItem(userKey, username); } catch(e) {}
                updateUsernameUI();
                closeProfileModal();
                showToast("Profil mis Ã  jour !");
            }
        }
        function updateUsernameUI() { document.getElementById('username-display').innerText = username; }

        // --- 3. CORE (CRUD) ---
        function init() {
            loadUsername();
            try { const saved = localStorage.getItem(storageKey); if(saved) notes = JSON.parse(saved); } catch(e) {}
            if (notes.length===0) createNewNote(false); else loadNote(notes[0].id);
        }
        function saveToStorage() { try { localStorage.setItem(storageKey, JSON.stringify(notes)); } catch(e) { showToast("Erreur sauvegarde locale", "error"); } }
        function createNewNote(shouldRender = true) {
            currentNoteId = Date.now().toString(); currentImages = []; currentColor = 'transparent';
            document.getElementById('note-title').value = ""; document.getElementById('note-content').value = "";
            renderImages(); if(window.innerWidth<768) toggleSidebar(false); showStatus("Nouveau brouillon");
        }
        function saveCurrentNote() {
            const t = document.getElementById('note-title').value.trim(); const c = document.getElementById('note-content').value;
            if(!t && !c && !currentImages.length) { showToast("Note vide !","error"); return; }
            const n = { id: currentNoteId, title: t||"Note sans titre", content: c, images: currentImages, color: currentColor, author: username, updatedAt: Date.now() };
            const idx = notes.findIndex(x=>x.id===currentNoteId); if(idx>=0) notes[idx]=n; else notes.unshift(n);
            saveToStorage(); renderNotesList(); showToast("SauvegardÃ©"); showStatus("SauvegardÃ© Ã  "+new Date().toLocaleTimeString());
        }
        function loadNote(id) {
            const n = notes.find(x=>x.id===id); if(!n) return;
            currentNoteId = n.id; document.getElementById('note-title').value=n.title; document.getElementById('note-content').value=n.content||"";
            currentImages = n.images||[]; currentColor = n.color || 'transparent';
            renderImages(); renderNotesList(); if(window.innerWidth<768) toggleSidebar(false);
        }
        function deleteNote(e, id) {
            e.stopPropagation(); if(!confirm("Supprimer?")) return;
            notes=notes.filter(x=>x.id!==id); saveToStorage();
            if(currentNoteId===id) { if(notes.length) loadNote(notes[0].id); else createNewNote(); } else renderNotesList();
            showToast("Note supprimÃ©e");
        }

        // --- 4. UI ---
        function renderNotesList() {
            const lst = document.getElementById('notes-list'); lst.innerHTML = "";
            let dNotes = notes;
            if(searchTerm) { const s = normalizeText(searchTerm); dNotes = notes.filter(n=>normalizeText(n.title||"").includes(s)||normalizeText(n.content||"").includes(s)); }
            if(!dNotes.length) { lst.innerHTML=`<div class="text-center py-10 text-slate-400 text-sm italic">Aucune note</div>`; return; }
            dNotes.sort((a,b)=>b.updatedAt-a.updatedAt).forEach(n => {
                const act = n.id===currentNoteId; const tit = searchTerm ? highlightTitle(n.title, searchTerm) : (n.title||"Sans titre");
                const colorClass = getColorClass(n.color || 'transparent');
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer border mb-2 group transition-all duration-200 ${colorClass} ${act ? 'ring-2 ring-indigo-500 shadow-md' : 'border-transparent hover:shadow-sm'}`;
                div.onclick=()=>loadNote(n.id);
                const auth = (n.author && n.author !== username) ? `<span class="ml-auto text-[9px] bg-slate-200 dark:bg-slate-600 px-1 rounded text-slate-500 dark:text-slate-300">par ${n.author}</span>` : '';
                div.innerHTML=`<div class="flex justify-between mb-1 items-center"><h3 class="font-semibold text-sm truncate text-slate-800 dark:text-slate-200 flex-1 flex items-center gap-1">${tit}</h3>${auth}<button onclick="deleteNote(event,'${n.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 px-1 ml-1">âœ•</button></div><p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2">${n.content?n.content.substring(0,50)+"...":(n.images.length?"[Photos]":"Vide")}</p>`;
                lst.appendChild(div);
            });
        }
        function renderImages() {
            const g = document.getElementById('image-grid'); const c = document.getElementById('image-grid-container');
            if(!currentImages.length) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden'); document.getElementById('img-count').innerText=currentImages.length; g.innerHTML="";
            currentImages.forEach((src,i)=>{
                const d=document.createElement('div'); d.className="relative group rounded-xl overflow-hidden shadow-sm aspect-square bg-slate-100 dark:bg-slate-700";
                d.innerHTML=`<img src="${src}" class="w-full h-full object-cover"><button onclick="currentImages.splice(${i},1);renderImages()" class="absolute inset-0 bg-black/40 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">Supprimer</button>`;
                g.appendChild(d);
            });
        }

        // --- 5. EXPORT & BACKUP ---
        function backupAllNotes() {
            if (!notes.length) { showToast("Rien Ã  sauvegarder", "error"); return; }
            downloadJSON({ type: 'calepin_full_backup', user: username, timestamp: Date.now(), count: notes.length, data: notes }, `backup_${username}_${new Date().toISOString().slice(0,10)}.json`);
            showToast(`Backup crÃ©Ã© !`);
        }
        function shareNoteFile() {
            const t = document.getElementById('note-title').value.trim();
            const n = { id: Date.now().toString(), title: t||"Note PartagÃ©e", content: document.getElementById('note-content').value, images: currentImages, author: username, updatedAt: Date.now() };
            downloadJSON(n, `${(t||"note").replace(/[^a-z0-9]/gi,'_')}.json`);
        }
        function downloadJSON(d, f) { const b = new Blob([JSON.stringify(d, null, 2)], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = f; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u); }
        function handleUniversalImport(input) {
            const f = input.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const j = JSON.parse(e.target.result); let c = 0;
                    if (j.type === 'calepin_full_backup' && Array.isArray(j.data)) {
                        if(!confirm(`Restaurer ${j.data.length} notes ?`)) return;
                        j.data.forEach(n => { if (!notes.some(ex => ex.id === n.id)) { notes.unshift(n); c++; } });
                    } else if (j.title || j.content) {
                        j.id = Date.now().toString() + Math.floor(Math.random()*1000);
                        j.title = "[Import] " + (j.title || "Note"); j.author = j.author || "Inconnu";
                        notes.unshift(j); c++; loadNote(j.id);
                    }
                    if(c > 0) { saveToStorage(); renderNotesList(); showToast(`${c} notes importÃ©es`); } else showToast("Aucune nouvelle note", "error");
                } catch (err) { console.error(err); showToast("Fichier invalide", "error"); }
                input.value = "";
            };
            r.readAsText(f);
        }

        // --- 6. UTILS ---
        function handleImageUpload(inp) { if(!inp.files[0]) return; showStatus("Compression..."); const r=new FileReader(); r.readAsDataURL(inp.files[0]); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const s=800/Math.max(i.width,800); c.width=i.width*s; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); currentImages.push(c.toDataURL('image/jpeg',0.7)); renderImages(); showStatus("Image ajoutÃ©e"); inp.value=""; }}; }
        function runLocalAI(t) { if(!t||t.length<10) return null; const w = t.toLowerCase().match(/\b[\wÃ Ã¢Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã»Ã¹Ã¼Ã¿Ã±Ã¦Å“]+\b/g)||[]; const m = w.filter(x=>!stopWords.has(x)&&x.length>2); const f={}; m.forEach(x=>f[x]=(f[x]||0)+1); const k = Object.entries(f).sort((a,b)=>b[1]-a[1]).slice(0,5).map(p=>p[0]); const s = (t.match(/[^\.!\?]+[\.!\?]+/g)||[t]).slice(0,2).join(" "); let sc=0; m.forEach(x=>{ if(["bon","bien","super"].includes(x)) sc++; if(["mal","nul","triste"].includes(x)) sc--; }); return { summary: s||t.substring(0,100)+"...", keywords: k, sentiment: sc>0?"Positif ðŸ˜Š":(sc<0?"NÃ©gatif ðŸ˜Ÿ":"Neutre ðŸ˜"), readTime: Math.ceil(w.length/200)+" min" }; }
        function analyzeCurrentNote() { const txt = (document.getElementById('note-title').value+". "+document.getElementById('note-content').value).trim(); if(txt.length<20) { showToast("Trop court","error"); return; } const r = runLocalAI(txt); document.getElementById('ai-summary').innerText = r.summary; document.getElementById('ai-keywords').innerHTML = r.keywords.map(k=>`<span class="px-2 py-1 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-200 text-indigo-700 text-xs rounded-full capitalize">${k}</span>`).join(""); document.getElementById('ai-sentiment').innerText = r.sentiment; document.getElementById('ai-readtime').innerText = r.readTime; document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-modal').classList.add('flex'); }
        function closeAiModal() { document.getElementById('ai-modal').classList.add('hidden'); document.getElementById('ai-modal').classList.remove('flex'); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('calepin-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        if (localStorage.getItem('calepin-theme') === 'dark') document.documentElement.classList.add('dark');
        function handleSearch(v) { searchTerm = v.trim(); renderNotesList(); }
        function setNoteColor(c) { currentColor = c; saveCurrentNote(); }
        function getColorClass(c) { switch(c) { case 'red': return 'border-l-4 border-l-red-400 bg-red-50 dark:bg-red-900/20'; case 'green': return 'border-l-4 border-l-emerald-400 bg-emerald-50 dark:bg-emerald-900/20'; case 'blue': return 'border-l-4 border-l-sky-400 bg-sky-50 dark:bg-sky-900/20'; case 'yellow': return 'border-l-4 border-l-amber-400 bg-amber-50 dark:bg-amber-900/20'; default: return 'border-l-4 border-l-transparent bg-white dark:bg-slate-800'; } }
        document.addEventListener('keydown', (e) => { if ((e.ctrlKey||e.metaKey)) { if (e.key === 's') { e.preventDefault(); saveCurrentNote(); } if (e.key === 'n') { e.preventDefault(); createNewNote(); } } });
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let recognition = null; let isRecording = false; if (SpeechRecognition) { recognition = new SpeechRecognition(); recognition.continuous = true; recognition.lang = 'fr-FR'; recognition.onresult = (e) => { const tr = Array.from(e.results).map(r=>r[0].transcript).join(''); const ta = document.getElementById('note-content'); ta.value += (ta.value.length?" ":"")+tr; ta.scrollTop = ta.scrollHeight; }; recognition.onerror = () => { stopDictation(); showToast("Erreur micro", "error"); }; }
        function toggleDictation() { if (!recognition) { alert("Incompatible"); return; } isRecording ? stopDictation() : startDictation(); }
        function startDictation() { isRecording = true; recognition.start(); document.getElementById('mic-btn').classList.add('recording'); showStatus("Micro actif..."); }
        function stopDictation() { isRecording = false; recognition.stop(); document.getElementById('mic-btn').classList.remove('recording'); showStatus("PrÃªt"); }
        function normalizeText(t) { return t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
        function highlightTitle(t, term) { return (!term || !t) ? (t||"Sans titre") : t.replace(new RegExp(`(${term})`,'gi'), '<mark>$1</mark>'); }
        function toggleSidebar(f) { const s=document.getElementById('sidebar'); const o=document.getElementById('overlay'); if(f!==undefined?f:s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } }
        function showToast(m,t='s') { const el=document.getElementById('toast'); el.innerText=m; el.className=`fixed top-4 right-4 z-50 px-4 py-2 rounded shadow text-white text-sm transition ${t==='error'?'bg-red-500':'bg-emerald-600'}`; setTimeout(()=>el.classList.add('opacity-0','-translate-y-2'),3000); el.classList.remove('opacity-0','-translate-y-2'); }
        function showStatus(m) { document.getElementById('status-msg').innerText=m; }
        function exportHTML() { const t=document.getElementById('note-title').value||"Note"; const c=document.getElementById('note-content').value; let h=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${t}</title><style>body{font-family:sans-serif;max-width:800px;margin:20px auto;padding:20px}img{max-width:100%;border-radius:8px;margin-top:10px}</style></head><body><h1>${t}</h1><div>${c}</div>`; if(currentImages.length) h+=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;margin-top:20px">`+currentImages.map(i=>`<img src="${i}">`).join('')+`</div>`; h+=`</body></html>`; document.getElementById('export-area').value=h; document.getElementById('export-modal').classList.remove('hidden'); document.getElementById('export-modal').classList.add('flex'); }
        function closeExportModal() { document.getElementById('export-modal').classList.add('hidden'); document.getElementById('export-modal').classList.remove('flex'); }
        function copyToClipboard() { document.getElementById('export-area').select(); document.execCommand('copy'); showToast("CopiÃ©!"); }

        init();
    </script>
</body>
</html>


